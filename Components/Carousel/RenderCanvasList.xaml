<?xml version="1.0" encoding="utf-8" ?>
<toolkit:Popup
  xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
  xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
  xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
  xmlns:models="clr-namespace:LunaDraw.Logic.Models"
  xmlns:pages="clr-namespace:LunaDraw.Components.Carousel"
  xmlns:converters="clr-namespace:LunaDraw.Converters"
  x:Class="LunaDraw.Components.Carousel.RenderCanvasList"
  x:Name="PageRef"
  x:DataType="pages:RenderCanvasList"
  CanBeDismissedByTappingOutsideOfPopup="True">

  <toolkit:Popup.Resources>
    <ResourceDictionary>
      <converters:InverseBoolConverter x:Key="InverseBoolConverter"/>
    </ResourceDictionary>
  </toolkit:Popup.Resources>

  <Border StrokeThickness="0"
          BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
          StrokeShape="RoundRectangle 12"
          WidthRequest="600"
          HeightRequest="500"
          Padding="0">
      
      <Grid x:Name="RootContainer"
            HorizontalOptions="FillAndExpand"
            VerticalOptions="FillAndExpand">
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto"/>
          <RowDefinition Height="Auto"/>
          <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Grid Grid.Row="0" ColumnDefinitions="*, Auto, Auto, Auto" Padding="10" BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2D2D2D}">
            <Label Text="Gallery" FontAttributes="Bold" FontSize="18" VerticalOptions="Center"/>
            
            <Button Grid.Column="1" Text="View" Command="{Binding ViewModel.ToggleViewCommand}" Margin="5,0" HeightRequest="30" Padding="10,0"/>
            <Button Grid.Column="2" Text="Sort" Command="{Binding ViewModel.ShowHideSortPanelCommand}" Margin="5,0" HeightRequest="30" Padding="10,0"/>
            <Button Grid.Column="3" Text="Search" Command="{Binding ViewModel.ShowHideSearchPanelCommand}" Margin="5,0" HeightRequest="30" Padding="10,0"/>
        </Grid>
        
        <!-- Search/Sort Panels -->
        <StackLayout Grid.Row="1">
            <!-- Search Panel -->
            <StackLayout x:Name="SearchPanel"
                         Orientation="Horizontal"
                         IsVisible="{Binding ViewModel.IsSearchVisible}"
                         BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                         Padding="10">
              <Label Text="Search" VerticalOptions="Center"/>
              <Entry Text="{Binding ViewModel.SearchText}"
                     HorizontalOptions="FillAndExpand"
                     Placeholder="Search drawings..."/>
              <Button Text="X"
                      Command="{Binding ViewModel.ClearSearchPanelCommand}"
                      WidthRequest="40"
                      HeightRequest="40"/>
            </StackLayout>

            <!-- Sort Panel -->
            <StackLayout x:Name="SortPanel"
                         Orientation="Horizontal"
                         IsVisible="{Binding ViewModel.IsSortVisible}"
                         BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                         Padding="10">
              <Picker Title="Sort by"
                      ItemsSource="{Binding ViewModel.SortProperties}"
                      SelectedItem="{Binding ViewModel.ChartListSortProperty}"
                      HorizontalOptions="FillAndExpand"/>
              <Picker Title="Direction"
                      ItemsSource="{Binding ViewModel.SortOrders}"
                      SelectedItem="{Binding ViewModel.ChartListSortOrder}"
                      HorizontalOptions="FillAndExpand"/>
            </StackLayout>
        </StackLayout>

        <!-- List/Grid Content -->
        <Grid Grid.Row="2">
            <!-- List View Mode -->
            <CollectionView x:Name="ChartList"
                      SelectionMode="Single"
                      SelectionChanged="CollectionView_SelectionChanged"
                      ItemsSource="{Binding ViewModel.Charts}"
                      IsVisible="{Binding ViewModel.IsGridMode, Converter={x:StaticResource InverseBoolConverter}}">
              <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="pages:DrawingItemState">
                    <Grid Padding="10" ColumnDefinitions="*, Auto">
                      <Label Text="{Binding Title}"
                             FontSize="16"
                             VerticalTextAlignment="Center"
                             LineBreakMode="MiddleTruncation"/>
                      <Label Grid.Column="1" 
                             Text="{Binding DateCreated, StringFormat='{0:MM/dd/yyyy}'}"
                             FontSize="12"
                             TextColor="Gray"
                             VerticalTextAlignment="Center"/>
                    </Grid>
                </DataTemplate>
              </CollectionView.ItemTemplate>
              <CollectionView.EmptyView>
                  <Label Text="No drawings found" HorizontalOptions="Center" VerticalOptions="Center"/>
              </CollectionView.EmptyView>
            </CollectionView>

            <!-- Grid View Mode -->
            <CollectionView x:Name="ChartCollectionView"
                            Margin="10"
                            SelectionMode="Single"
                            SelectionChanged="CollectionView_SelectionChanged"
                            Scrolled="ChartGrid_Scrolled"
                            ItemsSource="{Binding ViewModel.Charts}"
                            IsVisible="{Binding ViewModel.IsGridMode}">
                <CollectionView.ItemsLayout>
                  <GridItemsLayout Orientation="Vertical"
                                   Span="2"
                                   HorizontalItemSpacing="10"
                                   VerticalItemSpacing="10"/>
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                  <DataTemplate x:DataType="pages:DrawingItemState">
                    <Border StrokeShape="RoundRectangle 8"
                           Stroke="#E0E0E0"
                           StrokeThickness="1"
                           HeightRequest="150"
                           Padding="0">
                      <Grid RowDefinitions="*,Auto">
                        <!-- Placeholder for Image -->
                        <BoxView Color="#E0E0E0" Grid.Row="0"/>
                        <Label Text="Image"
                               VerticalOptions="Center"
                               HorizontalOptions="Center"
                               TextColor="Gray"
                               Grid.Row="0"/>

                        <StackLayout Grid.Row="1"
                                     Padding="10"
                                     BackgroundColor="{AppThemeBinding Light=White, Dark=#2D2D2D}">
                          <Label Text="{Binding Title}"
                                 FontAttributes="Bold"
                                 LineBreakMode="TailTruncation"/>
                          <Label Text="{Binding DateCreated, StringFormat='{0:MM/dd/yyyy}'}"
                                 FontSize="10"
                                 TextColor="Gray"/>
                        </StackLayout>
                      </Grid>
                    </Border>
                  </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
            
            <!-- Loading Indicator -->
            <ActivityIndicator IsRunning="{Binding ViewModel.IsLoading}"
                               IsVisible="{Binding ViewModel.IsLoading}"
                               Color="{StaticResource Primary}"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"/>
        </Grid>

        <!-- Floating Action Button -->
        <Button Grid.Row="2"
                Text="+"
                CornerRadius="28"
                WidthRequest="56"
                HeightRequest="56"
                FontSize="24"
                Padding="0"
                HorizontalOptions="End"
                VerticalOptions="End"
                Margin="20"
                Command="{Binding ViewModel.AddNewChartCommand}"
                BackgroundColor="#512BD4"
                TextColor="White"/>
      </Grid>
  </Border>
</toolkit:Popup>