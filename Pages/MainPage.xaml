<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:LunaDraw.Pages"
             xmlns:views="clr-namespace:LunaDraw.Views"
             xmlns:components="clr-namespace:LunaDraw.Components"
             xmlns:viewModels="clr-namespace:LunaDraw.Logic.ViewModels"
             xmlns:skiasharp="clr-namespace:SkiaSharp.Views.Maui.Controls;assembly=SkiaSharp.Views.Maui.Controls"
             x:DataType="viewModels:MainViewModel"
             x:Class="LunaDraw.Pages.MainPage">

  <AbsoluteLayout>
    <!-- Main Content Grid -->
    <Grid AbsoluteLayout.LayoutBounds="0,0,1,1"
          AbsoluteLayout.LayoutFlags="All">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="Auto"/>
        <ColumnDefinition Width="*"/>
      </Grid.ColumnDefinitions>

      <views:ToolbarView Grid.Column="0"
                         x:Name="toolbarView"/>

      <skiasharp:SKGLView Grid.Column="1"
                          x:Name="canvasView"
                          PaintSurface="OnCanvasViewPaintSurface"
                          EnableTouchEvents="True"
                          Touch="OnTouch"
                          IgnorePixelScaling="False">
        <skiasharp:SKGLView.GestureRecognizers>
          <TapGestureRecognizer Tapped="OnCanvasTapped"/>
        </skiasharp:SKGLView.GestureRecognizers>
      </skiasharp:SKGLView>
    </Grid>

    <!-- Settings Flyout Panel as True Overlay -->
    <components:FlyoutPanel x:Name="SettingsFlyoutHost"
                            IsOpen="{Binding ToolbarViewModel.IsSettingsOpen}"
                            TargetElement="{x:Reference toolbarView}"
                            AnchorName="SettingsButton">
      <components:SettingsFlyoutPanel x:Name="SettingsFlyoutContent"
                                      BindingContext="{Binding ToolbarViewModel}"/>
    </components:FlyoutPanel>

    <!-- Shapes Flyout Panel as True Overlay -->
    <components:FlyoutPanel x:Name="ShapesFlyoutHost"
                            IsOpen="{Binding ToolbarViewModel.IsShapesFlyoutOpen}"
                            TargetElement="{x:Reference toolbarView}"
                            AnchorName="ShapesButton">
      <components:ShapesFlyoutPanel x:Name="ShapesFlyoutContent"
                                    BindingContext="{Binding ToolbarViewModel}"/>
    </components:FlyoutPanel>

    <!-- Brushes Flyout Panel as True Overlay -->
    <components:FlyoutPanel x:Name="BrushesFlyoutHost"
                            IsOpen="{Binding ToolbarViewModel.IsBrushesFlyoutOpen}"
                            TargetElement="{x:Reference toolbarView}"
                            AnchorName="BrushButton">
      <components:BrushesFlyoutPanel x:Name="BrushesFlyoutContent"
                                     BindingContext="{Binding ToolbarViewModel}"/>
    </components:FlyoutPanel>

    <!-- Navigation Control (Bottom Right) -->
    <VerticalStackLayout AbsoluteLayout.LayoutBounds="1,1, -1, -1"
                         AbsoluteLayout.LayoutFlags="PositionProportional"
                         Margin="20"
                         Spacing="10">

      <!-- Zoom Controls -->
      <HorizontalStackLayout Spacing="10"
                             HorizontalOptions="End">
        <Button Text="âŸ²"
                Style="{StaticResource ZoomButtonStyle}"
                Command="{Binding ResetZoomCommand}"
                ToolTipProperties.Text="Reset Zoom"/>
        <Button Text="-"
                Style="{StaticResource ZoomButtonStyle}"
                Command="{Binding ZoomOutCommand}"
                ToolTipProperties.Text="Zoom Out"/>
        <Button Text="+"
                Style="{StaticResource ZoomButtonStyle}"
                Command="{Binding ZoomInCommand}"
                ToolTipProperties.Text="Zoom In"/>
      </HorizontalStackLayout>

      <!-- Mini Map -->
      <Border Stroke="Gray"
              StrokeThickness="1"
              BackgroundColor="White"
              HeightRequest="200"
              WidthRequest="200">
        <components:MiniMapView BindingContext="{Binding}"/>
      </Border>

    </VerticalStackLayout>

    <!-- Layer Control (Top Right) -->
    <components:LayerControlView BindingContext="{Binding}"
                                 AbsoluteLayout.LayoutBounds="1,0, -1, -1"
                                 AbsoluteLayout.LayoutFlags="PositionProportional"
                                 Margin="20"/>

  </AbsoluteLayout>
</ContentPage>
