<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:LunaDraw.Pages"
             xmlns:views="clr-namespace:LunaDraw.Views"
             xmlns:components="clr-namespace:LunaDraw.Components"
             xmlns:viewModels="clr-namespace:LunaDraw.Logic.ViewModels"
             xmlns:skiasharp="clr-namespace:SkiaSharp.Views.Maui.Controls;assembly=SkiaSharp.Views.Maui.Controls"
             x:DataType="viewModels:MainViewModel"
             x:Class="LunaDraw.Pages.MainPage">

    <AbsoluteLayout>
        <!-- Main Content Grid -->
        <Grid AbsoluteLayout.LayoutBounds="0,0,1,1"
              AbsoluteLayout.LayoutFlags="All">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <views:ToolbarView Grid.Column="0"
                               x:Name="toolbarView"/>

            <skiasharp:SKCanvasView Grid.Column="1"
                                    x:Name="canvasView"
                                    PaintSurface="OnCanvasViewPaintSurface"
                                    EnableTouchEvents="True"
                                    Touch="OnTouch"/>
        </Grid>

        <!-- Overlay Background for dismissing flyouts -->
        <BoxView x:Name="FlyoutOverlay"
                 AbsoluteLayout.LayoutBounds="0,0,1,1"
                 AbsoluteLayout.LayoutFlags="All"
                 BackgroundColor="Transparent"
                 IsVisible="False">
            <BoxView.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnOverlayTapped"/>
            </BoxView.GestureRecognizers>
        </BoxView>

        <!-- Settings Flyout Panel as True Overlay -->
        <components:FlyoutPanel x:Name="SettingsFlyoutHost"
                                IsOpen="{Binding IsSettingsOpen}"
                                TargetElement="{x:Reference toolbarView}"
                                AnchorName="SettingsButton"
                                AbsoluteLayout.LayoutBounds="0,0,AutoSize,AutoSize">
            <components:SettingsFlyoutPanel x:Name="SettingsFlyoutContent"
                                            BindingContext="{Binding Source={x:Reference toolbarView}, Path=BindingContext}"/>
        </components:FlyoutPanel>

        <!-- Shapes Flyout Panel as True Overlay -->
        <components:FlyoutPanel x:Name="ShapesFlyoutHost"
                                IsOpen="{Binding BindingContext.IsShapesFlyoutOpen, Source={x:Reference toolbarView}}"
                                TargetElement="{x:Reference toolbarView}"
                                AnchorName="ShapesButton"
                                AbsoluteLayout.LayoutBounds="0,0,AutoSize,AutoSize">
            <components:ShapesFlyoutPanel x:Name="ShapesFlyoutContent"
                                          BindingContext="{Binding Source={x:Reference toolbarView}, Path=BindingContext}"/>
        </components:FlyoutPanel>
    </AbsoluteLayout>

</ContentPage>
